%section.section-cover
  .cover-overlay
  - if @campaign.read_attribute(:cover_image).present?
    .cover-image{ style: "background-image:url(#{asset_url(@campaign.cover_image_url(:lg))});" }
  - else
    .cover-image{ style: "background-image:url(#{asset_url("default-image.png")});" }
  .info-container
    .meta
      - if @campaign.success?
        .label
          성공
      .label
        서명
      - if @campaign.agents.any?
        .agent-info
          대상: #{@campaign.agents.first.name}
          - if @campaign.agents.count > 1
            외 #{@campaign.agents.count - 1}

    .campaign-title
      = @campaign.title
    .user
      .user-image-xs{ style: "background-image:url(#{asset_url(@campaign.user.image_url(:md))});" }
      .user-name
        = @campaign.user.nickname

%section.section-tab
  %ul.menu
    %li.active
      .menu-item
        내용
    %li
      .menu-item
        촉구
    %li
      .menu-item
        의견
        - if @campaign.comments.any?
          %span.count
            = number_with_limit(@campaign.comments.count, 1000)
    %li
      .menu-item
        소식
    %li
      .menu-item
        명단
        - if @campaign.signs.any?
          %span.count
            = number_with_limit(@campaign.signs.count, 1000)

%section.section-info
  .campaign-progress
    .campaign-label
      .current-message
        현재 #{number_with_delimiter(@campaign.signs.count, delimiter:",")}명이 서명하였습니다.
      - if @campaign.has_goal?
        #{number_with_delimiter(@campaign.signs_goal_count, delimiter:",")}명
      서명에 동참해주세요.
    - if @campaign.has_goal?
      .campaign-progress-bar
        .current-percent
          #{@campaign.percentage}%
        - if @campaign.success?
          .success-badge
            성공
          .signs-bar{ style: "width: 100%" }
        - else
          .signs-bar{ style: "width: #{@campaign.percentage}%" }
      .campaign-progress-meta.clearfix
        .signs-count
          서명 #{number_with_delimiter(@campaign.signs.count, delimiter:",")}
        .goal-count
          목표 #{number_with_delimiter(@campaign.signs_goal_count, delimiter:",")}
    .campaign-signs
      - @campaign.signs.recent.limit(3).each do |sign|
        .campaign-sign
          .signer-image{ style: "background-image:url(#{asset_url(sign.user_image_url)});" }
          .signed-message
            #{sign.user_name}님이 서명하셨습니다.

%section.section-body
  .section-title
    캠페인 소개
  .campaign-body
    = raw @campaign.body

%section.section-orders
  .section-title
    캠페인 촉구
  .order-title
    지금
    %span.underline
      #{@campaign.agents.first.name}
      - if @campaign.agents.count > 1
        외 #{@campaign.agents.count - 1}
    에 촉구해 주세요
  .order-info
    - order_users_with_name = @campaign.comments.joins(:orders).where.not(commenter_name: nil).order("comment_id desc").limit(3)
    - count_order_users = @campaign.comments.joins(:orders).select(:commenter_name, :commenter_email).distinct.count
    - if order_users_with_name.any?
      #{order_users_with_name.first.commenter_name}님
      - if count_order_users >=1
        외 #{@campaign.comments.joins(:orders).select(:commenter_name, :commenter_email).distinct.count - 1}분이
      촉구에 참여중입니다.
    - elsif count_order_users >= 1
      이름을 알리지 않은 #{count_order_users}분이 참여하고 있습니다.
    - else
      지금 바로 촉구하여 참여해보세요.
  .order-users
    - order_users_with_image = User.where(id: @campaign.comments.where.not(user_id: nil).uniq.pluck(:user_id)).limit(3)
    - if order_users_with_image.any?
      .user-images
        - order_users_with_image.reverse.each do |user|
          .user-image-sm.overlapped{ style: "background-image:url(#{asset_url(user.image_url(:md))});" }
    -if count_order_users > 3
      .more +
      .count= count_order_users - 3
  - agents = @campaign.agents
  - if agents.any?
    / 에어전트를 보여주는 순서는 무작위?
    .agents
      - agents.shuffle.take(3).each do |agent|
        .agent
          .agent-image{ style: "background-image:url(#{asset_url(agent.image_url(:md))});" }
            - case @campaign.statement_of(agent).stance
            - when "unsure"
              .agent-unsure 무응답
            - when "disagree"
              .agent-disagree 반대
            - when "agree"
              .agent-agree 찬성
          .agent-info
            .agent-name= agent.name
            / 소속 이름이 비어있는 경우는?
            / '환경부장관'을 '횐경부, 환경부장관'으로 원래 데이터를 바꿔야 할지
            .agent-organization= agent.organization
          .agent-order-btn
            %a{"href": "#", "data-target" => "#agent-request-modal-#{agent.id}", "data-toggle" => "modal", :type => "button" }
              #{Order.where(agent_id: agent).where(comment_id: @campaign.comments).count + 1}번째로
              촉구하기
        %div.modal.fade{id: "agent-request-modal-#{agent.id}", :role => "dialog", :tabindex => "-1"}
          .modal-dialog{:role => "document"}
            .modal-content
              .modal-header
                %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
                  %span{"aria-hidden" => "true"} &#215;
                %h4.modal-title
                  = image_tag agent.image.md.url, style: "height: 36px;"
                  %strong= agent.name
                  %span.text-muted= agent.organization
                  에게 촉구하기

              .modal-body
                .comments-form
                  = form_for Comment.new, html: { class: 'gov-action-form-validation' } do |f|
                    = f.hidden_field :commentable_type, value: 'Campaign'
                    = f.hidden_field :commentable_id, value: @campaign.id
                    = f.hidden_field :target_agent_id, value: agent.id
                    .gov-action-form-grecaptcha
                    - unless user_signed_in?
                      .form-group
                        = f.label :commenter_name
                        = f.text_field :commenter_name, class: 'form-control', data: { 'rule-required': true }
                      .form-group
                        = f.label :commenter_email, agent.email.present? ? "이메일(#{agent.name}님에게 메일을 발송하려면 반드시 넣어주세요)" : nil
                        = f.text_field :commenter_email, class: 'form-control'
                    .form-group
                      ~ f.text_area :body, placeholder: '촉구합니다...', class: 'form-control validate ' + ( is_redactorable? ? 'redactor' : ''), data: { 'rule-required': true }
                    - if agent.email.present?
                      .form-group
                        .checkbox
                          %label
                            = f.check_box :mailing, { checked: true }, 'ready', 'disable'
                            #{agent.name}님에게 메일로도 발송합니다.
                    = f.submit '작성', class: 'btn btn-primary btn-block'


      / 촉구 탭 완성 후 링크 추가
      .more 더 보기

%section.section-comments
  .section-title
    의견
  = form_for Comment.new, html: { class: 'comment-form' } do |f|
    .commenter-image{ style: "background-image:url(#{asset_url(@campaign.user.image_url(:xs))});" }
    = f.hidden_field :commentable_type, value: "Campaign"
    = f.hidden_field :commentable_id, value: @campaign.id
    .comment-right
      %a{"class": "comment-box", "href": "#", "data-target" => "#agent-request-modal-comment", "data-toggle" => "modal" }
      = f.submit '등록', class: 'comment-submit-btn'
  .comments
    - @campaign.comments.recent.limit(10).each do |comment|
      .comment
        .comment-controls
          %a
            삭제
          %a
            신고
          %a
            긴급신고
          %a
            박제
        .comment-form
          .commenter-image{ style: "background-image:url(#{asset_url(comment.user_image)});" }
          .comment-right
            .comment-header
              .nickname
                = comment.user_nickname
                - if comment.target_agents.any?
                  .comment-agent
                    = comment.target_agents.shuffle.first.name
                    - if comment.target_agents.count > 1
                      외 #{comment.target_agents.count - 1}
                    에 촉구
              %span.sign-info
                / comment로 알 수 있는 건.... 촉구? 서명?
                - if Order.where(comment: comment).present?
                  #{Order.where(comment: @campaign.comments).where("comment_id <= ?", comment.id).select(:comment_id).distinct.count}번째 서명자
                .date= date_f comment.updated_at
            .comment-body
              = raw comment.body
            .comment-footer
              = render 'likes/button', likable: comment

%section.section-sign-btn
  .sign-btn
    .sign-btn-text
      서명하기

%div.modal.fade{id: "agent-request-modal-comment", :role => "dialog", :tabindex => "-1"}
  .modal-dialog{:role => "document"}
    .modal-content
      .modal-header
        %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
          %span{"aria-hidden" => "true"} &#215;
        %h4.modal-title 의견 남기기

      .modal-body
        .comments-form
          = form_for Comment.new, html: { class: 'gov-action-form-validation' } do |f|
            = f.hidden_field :commentable_type, value: 'Campaign'
            = f.hidden_field :commentable_id, value: @campaign.id
            .gov-action-form-grecaptcha
            - unless user_signed_in?
              .form-group
                = f.label :commenter_name
                = f.text_field :commenter_name, class: 'form-control', data: { 'rule-required': true }
              .form-group
                = f.label :commenter_email
                = f.text_field :commenter_email, class: 'form-control'
            .form-group
              ~ f.text_area :body, placeholder: '제 생각은...', class: 'form-control validate ' + ( is_redactorable? ? 'redactor' : ''), data: { 'rule-required': true }
            = f.submit '작성', class: 'btn btn-primary btn-block'

/ %section.section-share
/   .facebook-btn
/   .twitter-btn
/   .copy-btn

/ %section.section-recommends
/   .recommends-title
/     가크의 다양한 캠페인을 만나보세요!
/   .campagins
/     .campaign
/       .campaign-img
/       .progress-bar
/       .campaign-title
/         수감자 자녀의 아동친화적 면접권 보장에 동참해주세요!
/       .sign-btn
/         서명하기



