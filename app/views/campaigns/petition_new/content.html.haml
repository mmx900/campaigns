= render 'campaigns/petition_new/section_cover'

= render 'campaigns/petition_new/section_tab', menu: 'content'

%section.section-panel
  = render 'campaigns/petition_new/section_right'

  %section.section-left.tab-content
    #content.tab-pane.fade.in.active
      %section.section-body
        .section-title
          캠페인 소개
        .campaign-body
          = raw @campaign.body

      %section.section-orders
        .section-title
          캠페인 촉구
        .order-title
          - if @campaign.agents.any?
            지금
            %span.underline
              #{@campaign.agents.first.name}
              - if @campaign.agents.count > 1
                외 #{@campaign.agents.count - 1}
            에 촉구해 주세요
          - else
            촉구 대상를 알려주세요.
        .order-info
          - order_users_with_name = @campaign.comments.joins(:orders).where.not(commenter_name: nil).order("comment_id desc").limit(3)
          - count_order_users = @campaign.comments.joins(:orders).select(:commenter_name, :commenter_email).distinct.count
          - if order_users_with_name.any?
            #{order_users_with_name.first.commenter_name}님
            - if count_order_users >=1
              외 #{@campaign.comments.joins(:orders).select(:commenter_name, :commenter_email).distinct.count - 1}분이
            촉구에 참여중입니다.
          - elsif count_order_users >= 1
            이름을 알리지 않은 #{count_order_users}분이 참여하고 있습니다.
          - else
            지금 바로 촉구하여 참여해보세요.
        .order-users
          - order_users_with_image = User.where(id: @campaign.comments.where.not(user_id: nil).uniq.pluck(:user_id)).limit(3)
          - if order_users_with_image.any?
            .user-images
              - order_users_with_image.reverse.each do |user|
                .user-image-sm.overlapped{ style: "background-image:url(#{asset_url(user.image_url(:md))});" }
          -if count_order_users > 3
            .more +
            .count= count_order_users - 3
        - agents = @campaign.agents
        - if agents.any?
          / 에어전트를 보여주는 순서는 무작위?
          .agents
            - agents.shuffle.take(3).each do |agent|
              .agent
                .agent-image{ style: "background-image:url(#{asset_url(agent.image_url(:md))});" }
                  - unless @campaign.statement_of(agent).present?
                    .agent-unsure 없음
                  - else
                    - case @campaign.statement_of(agent).stance
                    - when "unsure"
                      .agent-unsure 무응답
                    - when "disagree"
                      .agent-disagree 반대
                    - when "agree"
                      .agent-agree 찬성
                .agent-info
                  .agent-name= agent.name
                  / 소속 이름이 비어있는 경우는?
                  / '환경부장관'을 '횐경부, 환경부장관'으로 원래 데이터를 바꿔야 할지
                  .agent-organization= agent.organization
                .agent-order-btn
                  %a{"href": "#", "data-target" => "#agent-request-modal-#{agent.id}", "data-toggle" => "modal", :type => "button" }
                    #{Order.where(agent_id: agent).where(comment_id: @campaign.comments).count + 1}번째로
                    촉구하기
              %div.modal.fade{id: "agent-request-modal-#{agent.id}", :role => "dialog", :tabindex => "-1"}
                .modal-dialog{:role => "document"}
                  .modal-content
                    .modal-header
                      %button.close{"aria-label" => "Close", "data-dismiss" => "modal", :type => "button"}
                        %span{"aria-hidden" => "true"} &#215;
                      %h4.modal-title
                        = image_tag agent.image.md.url, style: "height: 36px;"
                        %strong= agent.name
                        %span.text-muted= agent.organization
                        에게 촉구하기

                    .modal-body
                      .comments-form
                        = form_for Comment.new, html: { class: 'gov-action-form-validation' } do |f|
                          = f.hidden_field :commentable_type, value: 'Campaign'
                          = f.hidden_field :commentable_id, value: @campaign.id
                          = f.hidden_field :target_agent_id, value: agent.id
                          .gov-action-form-grecaptcha
                          - unless user_signed_in?
                            .form-group
                              = f.label :commenter_name
                              = f.text_field :commenter_name, class: 'form-control', data: { 'rule-required': true }
                            .form-group
                              = f.label :commenter_email, agent.email.present? ? "이메일(#{agent.name}님에게 메일을 발송하려면 반드시 넣어주세요)" : nil
                              = f.text_field :commenter_email, class: 'form-control'
                          .form-group
                            ~ f.text_area :body, placeholder: '촉구합니다...', class: 'form-control validate ' + ( is_redactorable? ? 'redactor' : ''), data: { 'rule-required': true }
                          - if agent.email.present?
                            .form-group
                              .checkbox
                                %label
                                  = f.check_box :mailing, { checked: true }, 'ready', 'disable'
                                  #{agent.name}님에게 메일로도 발송합니다.
                          = f.submit '작성', class: 'btn btn-primary btn-block'


            / 촉구 탭 완성 후 링크 추가
            .more 더 보기

= render 'campaigns/petition_new/sign_button'
